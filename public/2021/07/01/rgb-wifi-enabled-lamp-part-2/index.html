<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>RGB WiFi enabled lamp (Part 2) | Lopeztel&#39;s Blog</title>
<meta name="keywords" content="100DaysToOffload, esp8266, RGBLamp">
<meta name="description" content="As promised in my previous entry, I’ll go into some details related to how I implemented effects on my RGB Lamp:
All the code is available at my github repo or the mirror repo on my self-hosted gitea instance
The idea is to have mqtt messages triggering different behavior in my code, the design consists in triggering a periodic function to change LED RGB values depending on the message topic and payload">
<meta name="author" content="lopeztel">
<link rel="canonical" href="https://lopeztel.xyz/blog/2021/07/01/rgb-wifi-enabled-lamp-part-2/">
<link crossorigin="anonymous" href="/blog/assets/css/stylesheet.b183800e2cfbb62c3bce2b2ba56cdb2dd33af76c75cf4550173d5dfebd7c68a6.css" integrity="sha256-sYOADiz7tiw7zisrpWzbLdM692x1z0VQFz1d/r18aKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://lopeztel.xyz/blog/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://lopeztel.xyz/blog/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://lopeztel.xyz/blog/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://lopeztel.xyz/blog/apple-touch-icon.png">
<link rel="mask-icon" href="https://lopeztel.xyz/blog/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="RGB WiFi enabled lamp (Part 2)" />
<meta property="og:description" content="As promised in my previous entry, I’ll go into some details related to how I implemented effects on my RGB Lamp:
All the code is available at my github repo or the mirror repo on my self-hosted gitea instance
The idea is to have mqtt messages triggering different behavior in my code, the design consists in triggering a periodic function to change LED RGB values depending on the message topic and payload" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lopeztel.xyz/blog/2021/07/01/rgb-wifi-enabled-lamp-part-2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-01T09:21:50&#43;00:00" />
<meta property="article:modified_time" content="2021-07-01T09:21:50&#43;00:00" /><meta property="og:site_name" content="Lopeztel&#39;s blog" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="RGB WiFi enabled lamp (Part 2)"/>
<meta name="twitter:description" content="As promised in my previous entry, I’ll go into some details related to how I implemented effects on my RGB Lamp:
All the code is available at my github repo or the mirror repo on my self-hosted gitea instance
The idea is to have mqtt messages triggering different behavior in my code, the design consists in triggering a periodic function to change LED RGB values depending on the message topic and payload"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://lopeztel.xyz/blog/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "RGB WiFi enabled lamp (Part 2)",
      "item": "https://lopeztel.xyz/blog/2021/07/01/rgb-wifi-enabled-lamp-part-2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "RGB WiFi enabled lamp (Part 2)",
  "name": "RGB WiFi enabled lamp (Part 2)",
  "description": "As promised in my previous entry, I’ll go into some details related to how I implemented effects on my RGB Lamp:\nAll the code is available at my github repo or the mirror repo on my self-hosted gitea instance\nThe idea is to have mqtt messages triggering different behavior in my code, the design consists in triggering a periodic function to change LED RGB values depending on the message topic and payload",
  "keywords": [
    "100DaysToOffload", "esp8266", "RGBLamp"
  ],
  "articleBody": "As promised in my previous entry, I’ll go into some details related to how I implemented effects on my RGB Lamp:\nAll the code is available at my github repo or the mirror repo on my self-hosted gitea instance\nThe idea is to have mqtt messages triggering different behavior in my code, the design consists in triggering a periodic function to change LED RGB values depending on the message topic and payload\nI’ll try to explain with code chunks, the lamp has 3 operation modes: Solid, Fade and Rainbow\nSolid This was the very first transition implemented, simple color setting depending on a 32 bit RGB value (8 bits per color)\n function mqttDataCb is called with topic /mqtt/lights/solid payload is assigned to a boolean and other mode booleans (fade and rainbow) are set to false. RGB combination is assigned to all LEDs  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65  void mqttDataCb(uint32_t *args, const char *topic, uint32_t topic_len, const char *data, uint32_t data_len) { char *topicBuf = (char *)os_zalloc(topic_len + 1), *dataBuf = (char *)os_zalloc(data_len + 1); MQTT_Client *client = (MQTT_Client *)args; os_memcpy(topicBuf, topic, topic_len); topicBuf[topic_len] = 0; os_memcpy(dataBuf, data, data_len); dataBuf[data_len] = 0; INFO_MSG(\"Receive topic: %s, data: %s length: %d \\r\\n\", topicBuf, dataBuf, data_len); int isRed = strcmp(topicBuf, \"/mqtt/lights/red\"); int isGreen = strcmp(topicBuf, \"/mqtt/lights/green\"); int isBlue = strcmp(topicBuf, \"/mqtt/lights/blue\"); int isFade = strcmp(topicBuf, \"/mqtt/lights/fade\"); int isSolid = strcmp(topicBuf, \"/mqtt/lights/solid\"); int isRainbow = strcmp(topicBuf, \"/mqtt/lights/rainbow\"); INFO_MSG(\"topic comparison result: R %d, G %d, B %d, fade %d, solid%d\\r\\n\", isRed, isGreen, isBlue, isFade, isSolid); if (isRed == 0) { received_red = dataBuf[0]; } else if (isGreen == 0) { received_green = dataBuf[0]; } else if (isBlue == 0) { received_blue = dataBuf[0]; } else if (isFade == 0) { fade = dataBuf[0]; solid = false; rainbow = false; } else if (isSolid == 0) { solid = dataBuf[0]; fade = false; rainbow = false; } else if (isRainbow == 0) { rainbow = dataBuf[0]; solid = false; fade = false; } os_free(topicBuf); os_free(dataBuf); if (solid) { os_timer_disarm(\u0026fadeTimer); //Disable timer for periodic function  INFO_MSG(\"Updated color is R:%d G:%d B:%d \\r\\n\", received_red, received_green, received_blue); int i; for (i = 0; i  NUMPIXELS; i++) { // Color takes RGB values, from 0,0,0 up to 255,255,255  setPixelColor(\u0026ledstrip, i, color_rgb(received_red, received_green, received_blue)); system_soft_wdt_feed(); } show(\u0026ledstrip); } else if (fade) { ... //Redacted for convenience  }else if(rainbow){ ... //Redacted for convenience  } }    Nothing else to do here, the Solid mode is simple and doesn’t need a periodic function to change anything, which is why the timer to trigger said function is just disabled (in case the previous mode depended on it) with os_timer_disarm(\u0026fade_timer) (more on this available in Espressif’s nonos SDK)  Fade I call the first one Fade because of the soft transitions between colors…\n function mqttDataCb is called with topic /mqtt/lights/fade after the payload value is assigned to a boolean, the periodic function timer is disarmed, some initialization happens: all LEDs are initialized to color blue, and a state machine is re-initialized (to start from a known state) This is the state machine declaration:  1 2 3 4 5 6 7 8 9 10  enum fade_state{ to_purple, to_red, to_orange, to_green, to_teal, to_blue }; enum fade_state FADESTATE = to_purple; //state machine initial state   This is the missing chunk in function mqttDataCb:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  } else if (fade) { fade_red = 0; //reset fade values  fade_green = 0; fade_blue = 255; FADESTATE = to_purple; // MQTT_Publish(client,\"/mqtt/lights/solid\",0,1,2,0);  for (uint8_t i = 0; i  NUMPIXELS; i++) { // Color takes RGB values, from 0,0,0 up to 255,255,255  setPixelColor(\u0026ledstrip, i, color_rgb(fade_red, fade_green, fade_blue)); system_soft_wdt_feed(); } show(\u0026ledstrip); //initialize timer  os_timer_disarm(\u0026fadeTimer); os_timer_setfn(\u0026fadeTimer, (os_timer_func_t *)fadeFunction, NULL); os_timer_arm(\u0026fadeTimer, FADE_DELAY, 0); }else if(rainbow){    This function basically kickstarts the timer that calls fadeFunction, which in turn disarms the timer, checks which mode of operation is active and, in this case, cycles through the super fancy state machine (implemented as a simple switch statement), it just saturates or depletes a color to create the color transitions:  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64  static void ICACHE_FLASH_ATTR fadeFunction(void *arg) { os_timer_disarm(\u0026fadeTimer); if (fade) { switch (FADESTATE) { //Fade state machine  case to_purple: if (fade_red  255) { // purple  fade_red += 51; } else { FADESTATE = to_red; } break; case to_red: if (fade_blue  0) { // red  fade_blue -= 51; } else { FADESTATE = to_orange; } break; case to_orange: if (fade_green  255) { // orange  fade_green += 51; } else { FADESTATE = to_green; } break; case to_green: if (fade_red  0) { // green  fade_red -= 51; } else { FADESTATE = to_teal; } break; case to_teal: if (fade_blue  255) { // teal  fade_blue += 51; } else { FADESTATE = to_blue; } break; case to_blue: if (fade_green  0) { // blue  fade_green -= 51; } else { FADESTATE = to_purple; } break; default: break; } for (uint8_t i = 0; i  NUMPIXELS; i++) { setPixelColor(\u0026ledstrip, i, color_rgb(fade_red, fade_green, fade_blue)); system_soft_wdt_feed(); } show(\u0026ledstrip); }else if(rainbow){ ... // Redacted for convenience  } os_timer_setfn(\u0026fadeTimer, (os_timer_func_t *)fadeFunction, NULL); os_timer_arm(\u0026fadeTimer, FADE_DELAY, 0); }   Rainbow This is the most flashy (pun intended) mode of operation, it took what I call LED remapping (basically messing around with pointers), the soldering method shown in Thingiverse makes it hard to use simple mathematical operations to set the color LEDs periodically, initially I thought that using something like LED_index % 9 in a switch case would be enough but that doesn’t work for the snake like pattern I have, perhaps a diagram can illustrate what I mean:\nEssentially what I wanted was to have LEDs 0, 17, 18, 35, 36, 53, 54, 71 be “grouped” together and have the same color. Same applies to all others… So I created some structs that group the LEDs like this and had to manually point their elements to the corresponding LED numbers:\nThis are the corresponding chunks of code (not sure if function ledstrip_remap() is the best way to deal with the remapping, I’m pretty sure there should be a way to define this at compile time, food for thought):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233  #define NUMPIXELS\t72 #define COLOR_COMBINATIONS 6 #define LINES_IN_STRIP 9 #define LEDS_PER_LINE 8  typedef union{ struct{ //LSB to MSB  uint8_t red:8; uint8_t green:8; uint8_t blue:8; }b; uint32_t w; }color; typedef struct leds{ color LED_ARRAY[NUMPIXELS]; // led complete array }LEDS; typedef struct ledline{ color *LED_LINE_ELEMENTS[LEDS_PER_LINE]; // leds in line }LEDLINE; typedef struct ledstrip{ LEDLINE LED_LINES_IN_STRIP[LINES_IN_STRIP]; // led lines in strip }LEDSTRIP; LEDS all_leds; LEDSTRIP myledstrip; color rainbow_array[COLOR_COMBINATIONS]; void ledstrip_remap() { // it is important to rework this function if the total  // number of leds in your strip is not 72 (arranged in 9  // lines x 8 elements each)  // 1st ring  myledstrip.LED_LINES_IN_STRIP[0].LED_LINE_ELEMENTS[0] = \u0026all_leds.LED_ARRAY[0]; myledstrip.LED_LINES_IN_STRIP[0].LED_LINE_ELEMENTS[1] = \u0026all_leds.LED_ARRAY[17]; myledstrip.LED_LINES_IN_STRIP[0].LED_LINE_ELEMENTS[2] = \u0026all_leds.LED_ARRAY[18]; myledstrip.LED_LINES_IN_STRIP[0].LED_LINE_ELEMENTS[3] = \u0026all_leds.LED_ARRAY[35]; myledstrip.LED_LINES_IN_STRIP[0].LED_LINE_ELEMENTS[4] = \u0026all_leds.LED_ARRAY[36]; myledstrip.LED_LINES_IN_STRIP[0].LED_LINE_ELEMENTS[5] = \u0026all_leds.LED_ARRAY[53]; myledstrip.LED_LINES_IN_STRIP[0].LED_LINE_ELEMENTS[6] = \u0026all_leds.LED_ARRAY[54]; myledstrip.LED_LINES_IN_STRIP[0].LED_LINE_ELEMENTS[7] = \u0026all_leds.LED_ARRAY[71]; // 2nd ring  myledstrip.LED_LINES_IN_STRIP[1].LED_LINE_ELEMENTS[0] = \u0026all_leds.LED_ARRAY[1]; myledstrip.LED_LINES_IN_STRIP[1].LED_LINE_ELEMENTS[1] = \u0026all_leds.LED_ARRAY[16]; myledstrip.LED_LINES_IN_STRIP[1].LED_LINE_ELEMENTS[2] = \u0026all_leds.LED_ARRAY[19]; myledstrip.LED_LINES_IN_STRIP[1].LED_LINE_ELEMENTS[3] = \u0026all_leds.LED_ARRAY[34]; myledstrip.LED_LINES_IN_STRIP[1].LED_LINE_ELEMENTS[4] = \u0026all_leds.LED_ARRAY[37]; myledstrip.LED_LINES_IN_STRIP[1].LED_LINE_ELEMENTS[5] = \u0026all_leds.LED_ARRAY[52]; myledstrip.LED_LINES_IN_STRIP[1].LED_LINE_ELEMENTS[6] = \u0026all_leds.LED_ARRAY[55]; myledstrip.LED_LINES_IN_STRIP[1].LED_LINE_ELEMENTS[7] = \u0026all_leds.LED_ARRAY[70]; // 3rd ring  myledstrip.LED_LINES_IN_STRIP[2].LED_LINE_ELEMENTS[0] = \u0026all_leds.LED_ARRAY[2]; myledstrip.LED_LINES_IN_STRIP[2].LED_LINE_ELEMENTS[1] = \u0026all_leds.LED_ARRAY[15]; myledstrip.LED_LINES_IN_STRIP[2].LED_LINE_ELEMENTS[2] = \u0026all_leds.LED_ARRAY[20]; myledstrip.LED_LINES_IN_STRIP[2].LED_LINE_ELEMENTS[3] = \u0026all_leds.LED_ARRAY[33]; myledstrip.LED_LINES_IN_STRIP[2].LED_LINE_ELEMENTS[4] = \u0026all_leds.LED_ARRAY[38]; myledstrip.LED_LINES_IN_STRIP[2].LED_LINE_ELEMENTS[5] = \u0026all_leds.LED_ARRAY[51]; myledstrip.LED_LINES_IN_STRIP[2].LED_LINE_ELEMENTS[6] = \u0026all_leds.LED_ARRAY[56]; myledstrip.LED_LINES_IN_STRIP[2].LED_LINE_ELEMENTS[7] = \u0026all_leds.LED_ARRAY[69]; // 4th ring  myledstrip.LED_LINES_IN_STRIP[3].LED_LINE_ELEMENTS[0] = \u0026all_leds.LED_ARRAY[3]; myledstrip.LED_LINES_IN_STRIP[3].LED_LINE_ELEMENTS[1] = \u0026all_leds.LED_ARRAY[14]; myledstrip.LED_LINES_IN_STRIP[3].LED_LINE_ELEMENTS[2] = \u0026all_leds.LED_ARRAY[21]; myledstrip.LED_LINES_IN_STRIP[3].LED_LINE_ELEMENTS[3] = \u0026all_leds.LED_ARRAY[32]; myledstrip.LED_LINES_IN_STRIP[3].LED_LINE_ELEMENTS[4] = \u0026all_leds.LED_ARRAY[39]; myledstrip.LED_LINES_IN_STRIP[3].LED_LINE_ELEMENTS[5] = \u0026all_leds.LED_ARRAY[50]; myledstrip.LED_LINES_IN_STRIP[3].LED_LINE_ELEMENTS[6] = \u0026all_leds.LED_ARRAY[57]; myledstrip.LED_LINES_IN_STRIP[3].LED_LINE_ELEMENTS[7] = \u0026all_leds.LED_ARRAY[68]; // 5th ring  myledstrip.LED_LINES_IN_STRIP[4].LED_LINE_ELEMENTS[0] = \u0026all_leds.LED_ARRAY[4]; myledstrip.LED_LINES_IN_STRIP[4].LED_LINE_ELEMENTS[1] = \u0026all_leds.LED_ARRAY[13]; myledstrip.LED_LINES_IN_STRIP[4].LED_LINE_ELEMENTS[2] = \u0026all_leds.LED_ARRAY[22]; myledstrip.LED_LINES_IN_STRIP[4].LED_LINE_ELEMENTS[3] = \u0026all_leds.LED_ARRAY[31]; myledstrip.LED_LINES_IN_STRIP[4].LED_LINE_ELEMENTS[4] = \u0026all_leds.LED_ARRAY[40]; myledstrip.LED_LINES_IN_STRIP[4].LED_LINE_ELEMENTS[5] = \u0026all_leds.LED_ARRAY[49]; myledstrip.LED_LINES_IN_STRIP[4].LED_LINE_ELEMENTS[6] = \u0026all_leds.LED_ARRAY[58]; myledstrip.LED_LINES_IN_STRIP[4].LED_LINE_ELEMENTS[7] = \u0026all_leds.LED_ARRAY[67]; // 6th ring  myledstrip.LED_LINES_IN_STRIP[5].LED_LINE_ELEMENTS[0] = \u0026all_leds.LED_ARRAY[5]; myledstrip.LED_LINES_IN_STRIP[5].LED_LINE_ELEMENTS[1] = \u0026all_leds.LED_ARRAY[12]; myledstrip.LED_LINES_IN_STRIP[5].LED_LINE_ELEMENTS[2] = \u0026all_leds.LED_ARRAY[23]; myledstrip.LED_LINES_IN_STRIP[5].LED_LINE_ELEMENTS[3] = \u0026all_leds.LED_ARRAY[30]; myledstrip.LED_LINES_IN_STRIP[5].LED_LINE_ELEMENTS[4] = \u0026all_leds.LED_ARRAY[41]; myledstrip.LED_LINES_IN_STRIP[5].LED_LINE_ELEMENTS[5] = \u0026all_leds.LED_ARRAY[48]; myledstrip.LED_LINES_IN_STRIP[5].LED_LINE_ELEMENTS[6] = \u0026all_leds.LED_ARRAY[59]; myledstrip.LED_LINES_IN_STRIP[5].LED_LINE_ELEMENTS[7] = \u0026all_leds.LED_ARRAY[66]; // 7th ring  myledstrip.LED_LINES_IN_STRIP[6].LED_LINE_ELEMENTS[0] = \u0026all_leds.LED_ARRAY[6]; myledstrip.LED_LINES_IN_STRIP[6].LED_LINE_ELEMENTS[1] = \u0026all_leds.LED_ARRAY[11]; myledstrip.LED_LINES_IN_STRIP[6].LED_LINE_ELEMENTS[2] = \u0026all_leds.LED_ARRAY[24]; myledstrip.LED_LINES_IN_STRIP[6].LED_LINE_ELEMENTS[3] = \u0026all_leds.LED_ARRAY[29]; myledstrip.LED_LINES_IN_STRIP[6].LED_LINE_ELEMENTS[4] = \u0026all_leds.LED_ARRAY[42]; myledstrip.LED_LINES_IN_STRIP[6].LED_LINE_ELEMENTS[5] = \u0026all_leds.LED_ARRAY[47]; myledstrip.LED_LINES_IN_STRIP[6].LED_LINE_ELEMENTS[6] = \u0026all_leds.LED_ARRAY[60]; myledstrip.LED_LINES_IN_STRIP[6].LED_LINE_ELEMENTS[7] = \u0026all_leds.LED_ARRAY[65]; // 8th ring  myledstrip.LED_LINES_IN_STRIP[7].LED_LINE_ELEMENTS[0] = \u0026all_leds.LED_ARRAY[7]; myledstrip.LED_LINES_IN_STRIP[7].LED_LINE_ELEMENTS[1] = \u0026all_leds.LED_ARRAY[10]; myledstrip.LED_LINES_IN_STRIP[7].LED_LINE_ELEMENTS[2] = \u0026all_leds.LED_ARRAY[25]; myledstrip.LED_LINES_IN_STRIP[7].LED_LINE_ELEMENTS[3] = \u0026all_leds.LED_ARRAY[28]; myledstrip.LED_LINES_IN_STRIP[7].LED_LINE_ELEMENTS[4] = \u0026all_leds.LED_ARRAY[43]; myledstrip.LED_LINES_IN_STRIP[7].LED_LINE_ELEMENTS[5] = \u0026all_leds.LED_ARRAY[46]; myledstrip.LED_LINES_IN_STRIP[7].LED_LINE_ELEMENTS[6] = \u0026all_leds.LED_ARRAY[61]; myledstrip.LED_LINES_IN_STRIP[7].LED_LINE_ELEMENTS[7] = \u0026all_leds.LED_ARRAY[64]; // 9th ring  myledstrip.LED_LINES_IN_STRIP[8].LED_LINE_ELEMENTS[0] = \u0026all_leds.LED_ARRAY[8]; myledstrip.LED_LINES_IN_STRIP[8].LED_LINE_ELEMENTS[1] = \u0026all_leds.LED_ARRAY[9]; myledstrip.LED_LINES_IN_STRIP[8].LED_LINE_ELEMENTS[2] = \u0026all_leds.LED_ARRAY[26]; myledstrip.LED_LINES_IN_STRIP[8].LED_LINE_ELEMENTS[3] = \u0026all_leds.LED_ARRAY[27]; myledstrip.LED_LINES_IN_STRIP[8].LED_LINE_ELEMENTS[4] = \u0026all_leds.LED_ARRAY[44]; myledstrip.LED_LINES_IN_STRIP[8].LED_LINE_ELEMENTS[5] = \u0026all_leds.LED_ARRAY[45]; myledstrip.LED_LINES_IN_STRIP[8].LED_LINE_ELEMENTS[6] = \u0026all_leds.LED_ARRAY[62]; myledstrip.LED_LINES_IN_STRIP[8].LED_LINE_ELEMENTS[7] = \u0026all_leds.LED_ARRAY[63]; } void set_rainbow_element(uint8_t element_num, uint8_t red, uint8_t green, uint8_t blue){ rainbow_array[element_num].b.red = red; rainbow_array[element_num].b.green = blue; rainbow_array[element_num].b.blue = green; } void init_rainbow_array() { // it is important to rework this function if the  // desired color combination array doesn't have 6  // elements  set_rainbow_element(0, 0, 0, 255); // blue  set_rainbow_element(1, 255, 0, 255); // purple  set_rainbow_element(2, 255, 0, 0); // red  set_rainbow_element(3, 255, 255, 0); // orange  set_rainbow_element(4, 0, 255, 0); // green  set_rainbow_element(5, 0, 255, 255); // teal } void rotate_rainbow_array(){ color temp = rainbow_array[0]; for (uint8_t i = 0; i  COLOR_COMBINATIONS -1; i++) { rainbow_array[i] = rainbow_array[i+1]; } rainbow_array[COLOR_COMBINATIONS-1] = temp; } void set_strip_line_color(uint8_t line_num, color assigned_color) { for (uint8_t i = 0; i  LEDS_PER_LINE; i++) { myledstrip.LED_LINES_IN_STRIP[line_num].LED_LINE_ELEMENTS[i]-b.red = assigned_color.b.red; myledstrip.LED_LINES_IN_STRIP[line_num].LED_LINE_ELEMENTS[i]-b.green = assigned_color.b.green; myledstrip.LED_LINES_IN_STRIP[line_num].LED_LINE_ELEMENTS[i]-b.blue = assigned_color.b.blue; } }   Then the missing chunk of code in function fadeFunction is simpler:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  }else if(rainbow){ rotate_rainbow_array(); for (uint8_t i = 0; i  LINES_IN_STRIP; i++) { if (i  COLOR_COMBINATIONS) { set_strip_line_color(i, rainbow_array[i]); } else { set_strip_line_color(i, rainbow_array[i - COLOR_COMBINATIONS]); } } for (uint8_t i = 0; i  NUMPIXELS; i++) { // setPixelColor takes RGB values, from 0,0,0 up to 255,255,255,  // this function is part of the Adafruit_NeoPixel library  setPixelColor(\u0026ledstrip, i, color_rgb(all_leds.LED_ARRAY[i].b.red, all_leds.LED_ARRAY[i].b.green, all_leds.LED_ARRAY[i].b.blue)); system_soft_wdt_feed(); } show(\u0026ledstrip); }   This is my first attempt at explaining code in a blog post, hopefully the idea got across, at least writing this helps me organize my thoughts\n Day 15 of my 2021’s #100DaysToOffload\nJoin 100DaysToOffload!\n",
  "wordCount" : "1978",
  "inLanguage": "en",
  "datePublished": "2021-07-01T09:21:50Z",
  "dateModified": "2021-07-01T09:21:50Z",
  "author":{
    "@type": "Person",
    "name": "lopeztel"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://lopeztel.xyz/blog/2021/07/01/rgb-wifi-enabled-lamp-part-2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Lopeztel's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://lopeztel.xyz/blog/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://lopeztel.xyz/blog" accesskey="h" title="Lopeztel&#39;s Blog (Alt + H)">Lopeztel&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://lopeztel.xyz/blog/archives/" title="archives">
                    <span>archives</span>
                </a>
            </li>
            <li>
                <a href="https://lopeztel.xyz/blog/posts/" title="posts">
                    <span>posts</span>
                </a>
            </li>
            <li>
                <a href="https://lopeztel.xyz/blog/search/" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
            <li>
                <a href="https://lopeztel.xyz/blog/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://lopeztel.xyz/blog">Home</a>&nbsp;»&nbsp;<a href="https://lopeztel.xyz/blog/posts/">Posts</a></div>
    <h1 class="post-title">
      RGB WiFi enabled lamp (Part 2)
    </h1>
    <div class="post-meta"><span title='2021-07-01 09:21:50 +0000 +0000'>July 1, 2021</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;lopeztel

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#solid" aria-label="Solid">Solid</a></li>
                <li>
                    <a href="#fade" aria-label="Fade">Fade</a></li>
                <li>
                    <a href="#rainbow" aria-label="Rainbow">Rainbow</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>As promised in my previous <a href="https://lopeztel.xyz/blog/2021/06/24/rgb-wifi-enabled-lamp-part-1/">entry</a>, I’ll go into some details related to how I implemented effects on my RGB Lamp:</p>
<p>All the code is available at my <a href="https://github.com/lopeztel/esp8266_NeoPixel">github repo</a> or the <a href="https://lopeztel.noho.st/gitea/lopeztel/esp8266_NeoPixel">mirror repo</a> on my self-hosted gitea instance</p>
<p>The idea is to have mqtt messages triggering different behavior in my code, the design consists in triggering a periodic function to change LED RGB values depending on the message topic and payload</p>
<p>I’ll try to explain with code chunks, the lamp has 3 operation modes: <em>Solid</em>, <em>Fade</em> and <em>Rainbow</em></p>
<h2 id="solid">Solid<a hidden class="anchor" aria-hidden="true" href="#solid">#</a></h2>
<p>This was the very first transition implemented, simple color setting depending on a 32 bit RGB value (8 bits per color)</p>
<ul>
<li>function <code>mqttDataCb</code> is called with topic <code>/mqtt/lights/solid</code></li>
<li>payload is assigned to a boolean and other mode booleans (<em>fade</em> and <em>rainbow</em>) are set to false. RGB combination is assigned to all LEDs</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-0-1"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-1"> 1</a>
</span><span class="lnt" id="hl-0-2"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-2"> 2</a>
</span><span class="lnt" id="hl-0-3"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-3"> 3</a>
</span><span class="lnt" id="hl-0-4"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-4"> 4</a>
</span><span class="lnt" id="hl-0-5"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-5"> 5</a>
</span><span class="lnt" id="hl-0-6"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-6"> 6</a>
</span><span class="lnt" id="hl-0-7"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-7"> 7</a>
</span><span class="lnt" id="hl-0-8"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-8"> 8</a>
</span><span class="lnt" id="hl-0-9"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-9"> 9</a>
</span><span class="lnt" id="hl-0-10"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-10">10</a>
</span><span class="lnt" id="hl-0-11"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-11">11</a>
</span><span class="lnt" id="hl-0-12"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-12">12</a>
</span><span class="lnt" id="hl-0-13"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-13">13</a>
</span><span class="lnt" id="hl-0-14"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-14">14</a>
</span><span class="lnt" id="hl-0-15"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-15">15</a>
</span><span class="lnt" id="hl-0-16"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-16">16</a>
</span><span class="lnt" id="hl-0-17"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-17">17</a>
</span><span class="lnt" id="hl-0-18"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-18">18</a>
</span><span class="lnt" id="hl-0-19"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-19">19</a>
</span><span class="lnt" id="hl-0-20"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-20">20</a>
</span><span class="lnt" id="hl-0-21"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-21">21</a>
</span><span class="lnt" id="hl-0-22"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-22">22</a>
</span><span class="lnt" id="hl-0-23"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-23">23</a>
</span><span class="lnt" id="hl-0-24"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-24">24</a>
</span><span class="lnt" id="hl-0-25"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-25">25</a>
</span><span class="lnt" id="hl-0-26"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-26">26</a>
</span><span class="lnt" id="hl-0-27"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-27">27</a>
</span><span class="lnt" id="hl-0-28"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-28">28</a>
</span><span class="lnt" id="hl-0-29"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-29">29</a>
</span><span class="lnt" id="hl-0-30"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-30">30</a>
</span><span class="lnt" id="hl-0-31"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-31">31</a>
</span><span class="lnt" id="hl-0-32"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-32">32</a>
</span><span class="lnt" id="hl-0-33"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-33">33</a>
</span><span class="lnt" id="hl-0-34"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-34">34</a>
</span><span class="lnt" id="hl-0-35"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-35">35</a>
</span><span class="lnt" id="hl-0-36"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-36">36</a>
</span><span class="lnt" id="hl-0-37"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-37">37</a>
</span><span class="lnt" id="hl-0-38"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-38">38</a>
</span><span class="lnt" id="hl-0-39"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-39">39</a>
</span><span class="lnt" id="hl-0-40"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-40">40</a>
</span><span class="lnt" id="hl-0-41"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-41">41</a>
</span><span class="lnt" id="hl-0-42"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-42">42</a>
</span><span class="lnt" id="hl-0-43"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-43">43</a>
</span><span class="lnt" id="hl-0-44"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-44">44</a>
</span><span class="lnt" id="hl-0-45"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-45">45</a>
</span><span class="lnt" id="hl-0-46"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-46">46</a>
</span><span class="lnt" id="hl-0-47"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-47">47</a>
</span><span class="lnt" id="hl-0-48"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-48">48</a>
</span><span class="lnt" id="hl-0-49"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-49">49</a>
</span><span class="lnt" id="hl-0-50"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-50">50</a>
</span><span class="lnt" id="hl-0-51"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-51">51</a>
</span><span class="lnt" id="hl-0-52"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-52">52</a>
</span><span class="lnt" id="hl-0-53"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-53">53</a>
</span><span class="lnt" id="hl-0-54"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-54">54</a>
</span><span class="lnt" id="hl-0-55"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-55">55</a>
</span><span class="lnt" id="hl-0-56"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-56">56</a>
</span><span class="lnt" id="hl-0-57"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-57">57</a>
</span><span class="lnt" id="hl-0-58"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-58">58</a>
</span><span class="lnt" id="hl-0-59"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-59">59</a>
</span><span class="lnt" id="hl-0-60"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-60">60</a>
</span><span class="lnt" id="hl-0-61"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-61">61</a>
</span><span class="lnt" id="hl-0-62"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-62">62</a>
</span><span class="lnt" id="hl-0-63"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-63">63</a>
</span><span class="lnt" id="hl-0-64"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-64">64</a>
</span><span class="lnt" id="hl-0-65"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-0-65">65</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">mqttDataCb</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">topic</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">topic_len</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">topicBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">os_zalloc</span><span class="p">(</span><span class="n">topic_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">       <span class="o">*</span><span class="n">dataBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">os_zalloc</span><span class="p">(</span><span class="n">data_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">MQTT_Client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="p">(</span><span class="n">MQTT_Client</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">os_memcpy</span><span class="p">(</span><span class="n">topicBuf</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">topic_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">topicBuf</span><span class="p">[</span><span class="n">topic_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">os_memcpy</span><span class="p">(</span><span class="n">dataBuf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">dataBuf</span><span class="p">[</span><span class="n">data_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">INFO_MSG</span><span class="p">(</span><span class="s">&#34;Receive topic: %s, data: %s length: %d </span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">topicBuf</span><span class="p">,</span> <span class="n">dataBuf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">data_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">isRed</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">topicBuf</span><span class="p">,</span> <span class="s">&#34;/mqtt/lights/red&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">isGreen</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">topicBuf</span><span class="p">,</span> <span class="s">&#34;/mqtt/lights/green&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">isBlue</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">topicBuf</span><span class="p">,</span> <span class="s">&#34;/mqtt/lights/blue&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">isFade</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">topicBuf</span><span class="p">,</span> <span class="s">&#34;/mqtt/lights/fade&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">isSolid</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">topicBuf</span><span class="p">,</span> <span class="s">&#34;/mqtt/lights/solid&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">isRainbow</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">topicBuf</span><span class="p">,</span> <span class="s">&#34;/mqtt/lights/rainbow&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">INFO_MSG</span><span class="p">(</span><span class="s">&#34;topic comparison result: R %d, G %d, B %d, fade %d, solid%d</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">isRed</span><span class="p">,</span> <span class="n">isGreen</span><span class="p">,</span> <span class="n">isBlue</span><span class="p">,</span> <span class="n">isFade</span><span class="p">,</span> <span class="n">isSolid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">isRed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">received_red</span> <span class="o">=</span> <span class="n">dataBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isGreen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">received_green</span> <span class="o">=</span> <span class="n">dataBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isBlue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">received_blue</span> <span class="o">=</span> <span class="n">dataBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isFade</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fade</span> <span class="o">=</span> <span class="n">dataBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">solid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rainbow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isSolid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">solid</span> <span class="o">=</span> <span class="n">dataBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">fade</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rainbow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isRainbow</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">rainbow</span> <span class="o">=</span> <span class="n">dataBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">solid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">fade</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">os_free</span><span class="p">(</span><span class="n">topicBuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">os_free</span><span class="p">(</span><span class="n">dataBuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">solid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">os_timer_disarm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fadeTimer</span><span class="p">);</span> <span class="c1">//Disable timer for periodic function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">INFO_MSG</span><span class="p">(</span><span class="s">&#34;Updated color is R:%d G:%d B:%d </span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">received_red</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">received_green</span><span class="p">,</span> <span class="n">received_blue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMPIXELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Color takes RGB values, from 0,0,0 up to 255,255,255
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">setPixelColor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledstrip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">color_rgb</span><span class="p">(</span><span class="n">received_red</span><span class="p">,</span> <span class="n">received_green</span><span class="p">,</span> <span class="n">received_blue</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">system_soft_wdt_feed</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">show</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledstrip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fade</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="p">...</span> <span class="c1">//Redacted for convenience
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">rainbow</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">   <span class="p">...</span> <span class="c1">//Redacted for convenience
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Nothing else to do here, the <em>Solid</em> mode is simple and doesn’t need a periodic function to change anything, which is why the timer to trigger said function is just disabled (in case the previous mode depended on it) with <code>os_timer_disarm(&amp;fade_timer)</code> (more on this available in <a href="https://www.espressif.com/sites/default/files/documentation/2c-esp8266_non_os_sdk_api_reference_en.pdf">Espressif’s nonos SDK</a>)</li>
</ul>
<p><img loading="lazy" src="https://lopeztel.noho.st/piwigo/galleries/blog_media/Demo_compressed.gif#center" alt="Solid"  />
</p>
<h2 id="fade">Fade<a hidden class="anchor" aria-hidden="true" href="#fade">#</a></h2>
<p>I call the first one <em>Fade</em> because of the soft transitions between colors…</p>
<ul>
<li>function <code>mqttDataCb</code> is called with topic <code>/mqtt/lights/fade</code></li>
<li>after the payload value is assigned to a boolean, the periodic function timer is disarmed, some initialization happens: all LEDs are initialized to color blue, and a state machine is re-initialized (to start from a known state) This is the state machine declaration:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-1-1"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-1-1"> 1</a>
</span><span class="lnt" id="hl-1-2"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-1-2"> 2</a>
</span><span class="lnt" id="hl-1-3"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-1-3"> 3</a>
</span><span class="lnt" id="hl-1-4"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-1-4"> 4</a>
</span><span class="lnt" id="hl-1-5"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-1-5"> 5</a>
</span><span class="lnt" id="hl-1-6"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-1-6"> 6</a>
</span><span class="lnt" id="hl-1-7"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-1-7"> 7</a>
</span><span class="lnt" id="hl-1-8"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-1-8"> 8</a>
</span><span class="lnt" id="hl-1-9"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-1-9"> 9</a>
</span><span class="lnt" id="hl-1-10"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-1-10">10</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">fade_state</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">to_purple</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">to_red</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">to_orange</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">to_green</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">to_teal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">to_blue</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">fade_state</span> <span class="n">FADESTATE</span> <span class="o">=</span> <span class="n">to_purple</span><span class="p">;</span> <span class="c1">//state machine initial state
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This is the missing chunk in function <code>mqttDataCb</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-2-1"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-1"> 1</a>
</span><span class="lnt" id="hl-2-2"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-2"> 2</a>
</span><span class="lnt" id="hl-2-3"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-3"> 3</a>
</span><span class="lnt" id="hl-2-4"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-4"> 4</a>
</span><span class="lnt" id="hl-2-5"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-5"> 5</a>
</span><span class="lnt" id="hl-2-6"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-6"> 6</a>
</span><span class="lnt" id="hl-2-7"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-7"> 7</a>
</span><span class="lnt" id="hl-2-8"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-8"> 8</a>
</span><span class="lnt" id="hl-2-9"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-9"> 9</a>
</span><span class="lnt" id="hl-2-10"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-10">10</a>
</span><span class="lnt" id="hl-2-11"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-11">11</a>
</span><span class="lnt" id="hl-2-12"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-12">12</a>
</span><span class="lnt" id="hl-2-13"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-13">13</a>
</span><span class="lnt" id="hl-2-14"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-14">14</a>
</span><span class="lnt" id="hl-2-15"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-15">15</a>
</span><span class="lnt" id="hl-2-16"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-16">16</a>
</span><span class="lnt" id="hl-2-17"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-17">17</a>
</span><span class="lnt" id="hl-2-18"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-2-18">18</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fade</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">fade_red</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//reset fade values
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">fade_green</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fade_blue</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">FADESTATE</span> <span class="o">=</span> <span class="n">to_purple</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// MQTT_Publish(client,&#34;/mqtt/lights/solid&#34;,0,1,2,0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMPIXELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Color takes RGB values, from 0,0,0 up to 255,255,255
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">setPixelColor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledstrip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">color_rgb</span><span class="p">(</span><span class="n">fade_red</span><span class="p">,</span> <span class="n">fade_green</span><span class="p">,</span> <span class="n">fade_blue</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">system_soft_wdt_feed</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">show</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledstrip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//initialize timer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">os_timer_disarm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fadeTimer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">os_timer_setfn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fadeTimer</span><span class="p">,</span> <span class="p">(</span><span class="n">os_timer_func_t</span> <span class="o">*</span><span class="p">)</span><span class="n">fadeFunction</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">os_timer_arm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fadeTimer</span><span class="p">,</span> <span class="n">FADE_DELAY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">rainbow</span><span class="p">){</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>This function basically kickstarts the timer that calls <code>fadeFunction</code>, which in turn disarms the timer, checks which mode of operation is active and, in this case, cycles through the super fancy state machine (implemented as a simple switch statement), it just saturates or depletes a color to create the color transitions:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-3-1"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-1"> 1</a>
</span><span class="lnt" id="hl-3-2"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-2"> 2</a>
</span><span class="lnt" id="hl-3-3"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-3"> 3</a>
</span><span class="lnt" id="hl-3-4"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-4"> 4</a>
</span><span class="lnt" id="hl-3-5"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-5"> 5</a>
</span><span class="lnt" id="hl-3-6"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-6"> 6</a>
</span><span class="lnt" id="hl-3-7"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-7"> 7</a>
</span><span class="lnt" id="hl-3-8"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-8"> 8</a>
</span><span class="lnt" id="hl-3-9"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-9"> 9</a>
</span><span class="lnt" id="hl-3-10"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-10">10</a>
</span><span class="lnt" id="hl-3-11"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-11">11</a>
</span><span class="lnt" id="hl-3-12"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-12">12</a>
</span><span class="lnt" id="hl-3-13"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-13">13</a>
</span><span class="lnt" id="hl-3-14"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-14">14</a>
</span><span class="lnt" id="hl-3-15"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-15">15</a>
</span><span class="lnt" id="hl-3-16"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-16">16</a>
</span><span class="lnt" id="hl-3-17"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-17">17</a>
</span><span class="lnt" id="hl-3-18"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-18">18</a>
</span><span class="lnt" id="hl-3-19"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-19">19</a>
</span><span class="lnt" id="hl-3-20"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-20">20</a>
</span><span class="lnt" id="hl-3-21"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-21">21</a>
</span><span class="lnt" id="hl-3-22"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-22">22</a>
</span><span class="lnt" id="hl-3-23"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-23">23</a>
</span><span class="lnt" id="hl-3-24"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-24">24</a>
</span><span class="lnt" id="hl-3-25"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-25">25</a>
</span><span class="lnt" id="hl-3-26"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-26">26</a>
</span><span class="lnt" id="hl-3-27"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-27">27</a>
</span><span class="lnt" id="hl-3-28"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-28">28</a>
</span><span class="lnt" id="hl-3-29"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-29">29</a>
</span><span class="lnt" id="hl-3-30"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-30">30</a>
</span><span class="lnt" id="hl-3-31"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-31">31</a>
</span><span class="lnt" id="hl-3-32"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-32">32</a>
</span><span class="lnt" id="hl-3-33"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-33">33</a>
</span><span class="lnt" id="hl-3-34"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-34">34</a>
</span><span class="lnt" id="hl-3-35"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-35">35</a>
</span><span class="lnt" id="hl-3-36"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-36">36</a>
</span><span class="lnt" id="hl-3-37"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-37">37</a>
</span><span class="lnt" id="hl-3-38"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-38">38</a>
</span><span class="lnt" id="hl-3-39"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-39">39</a>
</span><span class="lnt" id="hl-3-40"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-40">40</a>
</span><span class="lnt" id="hl-3-41"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-41">41</a>
</span><span class="lnt" id="hl-3-42"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-42">42</a>
</span><span class="lnt" id="hl-3-43"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-43">43</a>
</span><span class="lnt" id="hl-3-44"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-44">44</a>
</span><span class="lnt" id="hl-3-45"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-45">45</a>
</span><span class="lnt" id="hl-3-46"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-46">46</a>
</span><span class="lnt" id="hl-3-47"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-47">47</a>
</span><span class="lnt" id="hl-3-48"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-48">48</a>
</span><span class="lnt" id="hl-3-49"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-49">49</a>
</span><span class="lnt" id="hl-3-50"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-50">50</a>
</span><span class="lnt" id="hl-3-51"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-51">51</a>
</span><span class="lnt" id="hl-3-52"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-52">52</a>
</span><span class="lnt" id="hl-3-53"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-53">53</a>
</span><span class="lnt" id="hl-3-54"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-54">54</a>
</span><span class="lnt" id="hl-3-55"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-55">55</a>
</span><span class="lnt" id="hl-3-56"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-56">56</a>
</span><span class="lnt" id="hl-3-57"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-57">57</a>
</span><span class="lnt" id="hl-3-58"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-58">58</a>
</span><span class="lnt" id="hl-3-59"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-59">59</a>
</span><span class="lnt" id="hl-3-60"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-60">60</a>
</span><span class="lnt" id="hl-3-61"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-61">61</a>
</span><span class="lnt" id="hl-3-62"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-62">62</a>
</span><span class="lnt" id="hl-3-63"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-63">63</a>
</span><span class="lnt" id="hl-3-64"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-3-64">64</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="n">ICACHE_FLASH_ATTR</span> <span class="nf">fadeFunction</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">os_timer_disarm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fadeTimer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fade</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">FADESTATE</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//Fade state machine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nl">to_purple</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">fade_red</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// purple
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">fade_red</span> <span class="o">+=</span> <span class="mi">51</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">FADESTATE</span> <span class="o">=</span> <span class="n">to_red</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">to_red</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">fade_blue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// red
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">fade_blue</span> <span class="o">-=</span> <span class="mi">51</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">FADESTATE</span> <span class="o">=</span> <span class="n">to_orange</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">to_orange</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">fade_green</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// orange
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">fade_green</span> <span class="o">+=</span> <span class="mi">51</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">FADESTATE</span> <span class="o">=</span> <span class="n">to_green</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">to_green</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">fade_red</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// green
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">fade_red</span> <span class="o">-=</span> <span class="mi">51</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">FADESTATE</span> <span class="o">=</span> <span class="n">to_teal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">to_teal</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">fade_blue</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// teal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">fade_blue</span> <span class="o">+=</span> <span class="mi">51</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">FADESTATE</span> <span class="o">=</span> <span class="n">to_blue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">to_blue</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">fade_green</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// blue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">fade_green</span> <span class="o">-=</span> <span class="mi">51</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">FADESTATE</span> <span class="o">=</span> <span class="n">to_purple</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMPIXELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">setPixelColor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledstrip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">color_rgb</span><span class="p">(</span><span class="n">fade_red</span><span class="p">,</span> <span class="n">fade_green</span><span class="p">,</span> <span class="n">fade_blue</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">system_soft_wdt_feed</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">show</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledstrip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">rainbow</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span> <span class="c1">// Redacted for convenience
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">os_timer_setfn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fadeTimer</span><span class="p">,</span> <span class="p">(</span><span class="n">os_timer_func_t</span> <span class="o">*</span><span class="p">)</span><span class="n">fadeFunction</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">os_timer_arm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fadeTimer</span><span class="p">,</span> <span class="n">FADE_DELAY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://lopeztel.noho.st/piwigo/galleries/blog_media/fade.gif#center" alt=""  />
</p>
<h2 id="rainbow">Rainbow<a hidden class="anchor" aria-hidden="true" href="#rainbow">#</a></h2>
<p>This is the most flashy (pun intended) mode of operation, it took what I call LED remapping (basically messing around with pointers), the soldering method shown in <a href="https://www.thingiverse.com/thing:4129249">Thingiverse</a> makes it hard to use simple mathematical operations to set the color LEDs periodically, initially I thought that using something like <code>LED_index % 9</code> in a switch case would be enough but that doesn’t work for the snake like pattern I have, perhaps a diagram can illustrate what I mean:</p>
<p><img loading="lazy" src="https://lopeztel.noho.st/piwigo/_data/i/galleries/blog_media/LED_strip_compressed-me.png#center" alt=""  />
</p>
<p>Essentially what I wanted was to have LEDs 0, 17, 18, 35, 36, 53, 54, 71 be “grouped” together and have the same color. Same applies to all others… So I created some <strong>structs</strong> that group the LEDs like this and had to manually point their elements to the corresponding LED numbers:</p>
<p><img loading="lazy" src="https://lopeztel.noho.st/piwigo/_data/i/galleries/blog_media/Led_strip_rearranged_compressed-me.png#center" alt=""  />
</p>
<p>This are the corresponding chunks of code (not sure if function <code>ledstrip_remap()</code> is the best way to deal with the remapping, I’m pretty sure there should be a way to define this at compile time, food for thought):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-4-1"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-1">  1</a>
</span><span class="lnt" id="hl-4-2"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-2">  2</a>
</span><span class="lnt" id="hl-4-3"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-3">  3</a>
</span><span class="lnt" id="hl-4-4"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-4">  4</a>
</span><span class="lnt" id="hl-4-5"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-5">  5</a>
</span><span class="lnt" id="hl-4-6"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-6">  6</a>
</span><span class="lnt" id="hl-4-7"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-7">  7</a>
</span><span class="lnt" id="hl-4-8"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-8">  8</a>
</span><span class="lnt" id="hl-4-9"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-9">  9</a>
</span><span class="lnt" id="hl-4-10"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-10"> 10</a>
</span><span class="lnt" id="hl-4-11"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-11"> 11</a>
</span><span class="lnt" id="hl-4-12"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-12"> 12</a>
</span><span class="lnt" id="hl-4-13"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-13"> 13</a>
</span><span class="lnt" id="hl-4-14"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-14"> 14</a>
</span><span class="lnt" id="hl-4-15"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-15"> 15</a>
</span><span class="lnt" id="hl-4-16"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-16"> 16</a>
</span><span class="lnt" id="hl-4-17"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-17"> 17</a>
</span><span class="lnt" id="hl-4-18"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-18"> 18</a>
</span><span class="lnt" id="hl-4-19"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-19"> 19</a>
</span><span class="lnt" id="hl-4-20"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-20"> 20</a>
</span><span class="lnt" id="hl-4-21"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-21"> 21</a>
</span><span class="lnt" id="hl-4-22"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-22"> 22</a>
</span><span class="lnt" id="hl-4-23"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-23"> 23</a>
</span><span class="lnt" id="hl-4-24"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-24"> 24</a>
</span><span class="lnt" id="hl-4-25"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-25"> 25</a>
</span><span class="lnt" id="hl-4-26"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-26"> 26</a>
</span><span class="lnt" id="hl-4-27"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-27"> 27</a>
</span><span class="lnt" id="hl-4-28"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-28"> 28</a>
</span><span class="lnt" id="hl-4-29"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-29"> 29</a>
</span><span class="lnt" id="hl-4-30"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-30"> 30</a>
</span><span class="lnt" id="hl-4-31"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-31"> 31</a>
</span><span class="lnt" id="hl-4-32"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-32"> 32</a>
</span><span class="lnt" id="hl-4-33"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-33"> 33</a>
</span><span class="lnt" id="hl-4-34"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-34"> 34</a>
</span><span class="lnt" id="hl-4-35"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-35"> 35</a>
</span><span class="lnt" id="hl-4-36"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-36"> 36</a>
</span><span class="lnt" id="hl-4-37"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-37"> 37</a>
</span><span class="lnt" id="hl-4-38"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-38"> 38</a>
</span><span class="lnt" id="hl-4-39"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-39"> 39</a>
</span><span class="lnt" id="hl-4-40"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-40"> 40</a>
</span><span class="lnt" id="hl-4-41"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-41"> 41</a>
</span><span class="lnt" id="hl-4-42"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-42"> 42</a>
</span><span class="lnt" id="hl-4-43"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-43"> 43</a>
</span><span class="lnt" id="hl-4-44"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-44"> 44</a>
</span><span class="lnt" id="hl-4-45"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-45"> 45</a>
</span><span class="lnt" id="hl-4-46"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-46"> 46</a>
</span><span class="lnt" id="hl-4-47"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-47"> 47</a>
</span><span class="lnt" id="hl-4-48"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-48"> 48</a>
</span><span class="lnt" id="hl-4-49"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-49"> 49</a>
</span><span class="lnt" id="hl-4-50"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-50"> 50</a>
</span><span class="lnt" id="hl-4-51"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-51"> 51</a>
</span><span class="lnt" id="hl-4-52"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-52"> 52</a>
</span><span class="lnt" id="hl-4-53"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-53"> 53</a>
</span><span class="lnt" id="hl-4-54"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-54"> 54</a>
</span><span class="lnt" id="hl-4-55"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-55"> 55</a>
</span><span class="lnt" id="hl-4-56"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-56"> 56</a>
</span><span class="lnt" id="hl-4-57"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-57"> 57</a>
</span><span class="lnt" id="hl-4-58"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-58"> 58</a>
</span><span class="lnt" id="hl-4-59"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-59"> 59</a>
</span><span class="lnt" id="hl-4-60"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-60"> 60</a>
</span><span class="lnt" id="hl-4-61"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-61"> 61</a>
</span><span class="lnt" id="hl-4-62"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-62"> 62</a>
</span><span class="lnt" id="hl-4-63"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-63"> 63</a>
</span><span class="lnt" id="hl-4-64"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-64"> 64</a>
</span><span class="lnt" id="hl-4-65"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-65"> 65</a>
</span><span class="lnt" id="hl-4-66"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-66"> 66</a>
</span><span class="lnt" id="hl-4-67"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-67"> 67</a>
</span><span class="lnt" id="hl-4-68"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-68"> 68</a>
</span><span class="lnt" id="hl-4-69"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-69"> 69</a>
</span><span class="lnt" id="hl-4-70"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-70"> 70</a>
</span><span class="lnt" id="hl-4-71"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-71"> 71</a>
</span><span class="lnt" id="hl-4-72"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-72"> 72</a>
</span><span class="lnt" id="hl-4-73"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-73"> 73</a>
</span><span class="lnt" id="hl-4-74"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-74"> 74</a>
</span><span class="lnt" id="hl-4-75"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-75"> 75</a>
</span><span class="lnt" id="hl-4-76"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-76"> 76</a>
</span><span class="lnt" id="hl-4-77"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-77"> 77</a>
</span><span class="lnt" id="hl-4-78"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-78"> 78</a>
</span><span class="lnt" id="hl-4-79"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-79"> 79</a>
</span><span class="lnt" id="hl-4-80"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-80"> 80</a>
</span><span class="lnt" id="hl-4-81"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-81"> 81</a>
</span><span class="lnt" id="hl-4-82"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-82"> 82</a>
</span><span class="lnt" id="hl-4-83"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-83"> 83</a>
</span><span class="lnt" id="hl-4-84"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-84"> 84</a>
</span><span class="lnt" id="hl-4-85"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-85"> 85</a>
</span><span class="lnt" id="hl-4-86"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-86"> 86</a>
</span><span class="lnt" id="hl-4-87"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-87"> 87</a>
</span><span class="lnt" id="hl-4-88"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-88"> 88</a>
</span><span class="lnt" id="hl-4-89"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-89"> 89</a>
</span><span class="lnt" id="hl-4-90"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-90"> 90</a>
</span><span class="lnt" id="hl-4-91"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-91"> 91</a>
</span><span class="lnt" id="hl-4-92"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-92"> 92</a>
</span><span class="lnt" id="hl-4-93"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-93"> 93</a>
</span><span class="lnt" id="hl-4-94"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-94"> 94</a>
</span><span class="lnt" id="hl-4-95"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-95"> 95</a>
</span><span class="lnt" id="hl-4-96"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-96"> 96</a>
</span><span class="lnt" id="hl-4-97"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-97"> 97</a>
</span><span class="lnt" id="hl-4-98"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-98"> 98</a>
</span><span class="lnt" id="hl-4-99"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-99"> 99</a>
</span><span class="lnt" id="hl-4-100"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-100">100</a>
</span><span class="lnt" id="hl-4-101"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-101">101</a>
</span><span class="lnt" id="hl-4-102"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-102">102</a>
</span><span class="lnt" id="hl-4-103"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-103">103</a>
</span><span class="lnt" id="hl-4-104"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-104">104</a>
</span><span class="lnt" id="hl-4-105"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-105">105</a>
</span><span class="lnt" id="hl-4-106"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-106">106</a>
</span><span class="lnt" id="hl-4-107"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-107">107</a>
</span><span class="lnt" id="hl-4-108"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-108">108</a>
</span><span class="lnt" id="hl-4-109"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-109">109</a>
</span><span class="lnt" id="hl-4-110"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-110">110</a>
</span><span class="lnt" id="hl-4-111"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-111">111</a>
</span><span class="lnt" id="hl-4-112"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-112">112</a>
</span><span class="lnt" id="hl-4-113"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-113">113</a>
</span><span class="lnt" id="hl-4-114"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-114">114</a>
</span><span class="lnt" id="hl-4-115"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-115">115</a>
</span><span class="lnt" id="hl-4-116"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-116">116</a>
</span><span class="lnt" id="hl-4-117"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-117">117</a>
</span><span class="lnt" id="hl-4-118"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-118">118</a>
</span><span class="lnt" id="hl-4-119"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-119">119</a>
</span><span class="lnt" id="hl-4-120"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-120">120</a>
</span><span class="lnt" id="hl-4-121"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-121">121</a>
</span><span class="lnt" id="hl-4-122"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-122">122</a>
</span><span class="lnt" id="hl-4-123"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-123">123</a>
</span><span class="lnt" id="hl-4-124"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-124">124</a>
</span><span class="lnt" id="hl-4-125"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-125">125</a>
</span><span class="lnt" id="hl-4-126"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-126">126</a>
</span><span class="lnt" id="hl-4-127"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-127">127</a>
</span><span class="lnt" id="hl-4-128"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-128">128</a>
</span><span class="lnt" id="hl-4-129"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-129">129</a>
</span><span class="lnt" id="hl-4-130"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-130">130</a>
</span><span class="lnt" id="hl-4-131"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-131">131</a>
</span><span class="lnt" id="hl-4-132"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-132">132</a>
</span><span class="lnt" id="hl-4-133"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-133">133</a>
</span><span class="lnt" id="hl-4-134"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-134">134</a>
</span><span class="lnt" id="hl-4-135"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-135">135</a>
</span><span class="lnt" id="hl-4-136"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-136">136</a>
</span><span class="lnt" id="hl-4-137"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-137">137</a>
</span><span class="lnt" id="hl-4-138"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-138">138</a>
</span><span class="lnt" id="hl-4-139"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-139">139</a>
</span><span class="lnt" id="hl-4-140"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-140">140</a>
</span><span class="lnt" id="hl-4-141"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-141">141</a>
</span><span class="lnt" id="hl-4-142"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-142">142</a>
</span><span class="lnt" id="hl-4-143"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-143">143</a>
</span><span class="lnt" id="hl-4-144"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-144">144</a>
</span><span class="lnt" id="hl-4-145"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-145">145</a>
</span><span class="lnt" id="hl-4-146"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-146">146</a>
</span><span class="lnt" id="hl-4-147"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-147">147</a>
</span><span class="lnt" id="hl-4-148"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-148">148</a>
</span><span class="lnt" id="hl-4-149"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-149">149</a>
</span><span class="lnt" id="hl-4-150"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-150">150</a>
</span><span class="lnt" id="hl-4-151"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-151">151</a>
</span><span class="lnt" id="hl-4-152"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-152">152</a>
</span><span class="lnt" id="hl-4-153"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-153">153</a>
</span><span class="lnt" id="hl-4-154"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-154">154</a>
</span><span class="lnt" id="hl-4-155"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-155">155</a>
</span><span class="lnt" id="hl-4-156"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-156">156</a>
</span><span class="lnt" id="hl-4-157"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-157">157</a>
</span><span class="lnt" id="hl-4-158"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-158">158</a>
</span><span class="lnt" id="hl-4-159"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-159">159</a>
</span><span class="lnt" id="hl-4-160"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-160">160</a>
</span><span class="lnt" id="hl-4-161"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-161">161</a>
</span><span class="lnt" id="hl-4-162"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-162">162</a>
</span><span class="lnt" id="hl-4-163"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-163">163</a>
</span><span class="lnt" id="hl-4-164"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-164">164</a>
</span><span class="lnt" id="hl-4-165"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-165">165</a>
</span><span class="lnt" id="hl-4-166"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-166">166</a>
</span><span class="lnt" id="hl-4-167"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-167">167</a>
</span><span class="lnt" id="hl-4-168"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-168">168</a>
</span><span class="lnt" id="hl-4-169"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-169">169</a>
</span><span class="lnt" id="hl-4-170"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-170">170</a>
</span><span class="lnt" id="hl-4-171"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-171">171</a>
</span><span class="lnt" id="hl-4-172"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-172">172</a>
</span><span class="lnt" id="hl-4-173"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-173">173</a>
</span><span class="lnt" id="hl-4-174"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-174">174</a>
</span><span class="lnt" id="hl-4-175"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-175">175</a>
</span><span class="lnt" id="hl-4-176"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-176">176</a>
</span><span class="lnt" id="hl-4-177"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-177">177</a>
</span><span class="lnt" id="hl-4-178"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-178">178</a>
</span><span class="lnt" id="hl-4-179"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-179">179</a>
</span><span class="lnt" id="hl-4-180"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-180">180</a>
</span><span class="lnt" id="hl-4-181"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-181">181</a>
</span><span class="lnt" id="hl-4-182"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-182">182</a>
</span><span class="lnt" id="hl-4-183"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-183">183</a>
</span><span class="lnt" id="hl-4-184"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-184">184</a>
</span><span class="lnt" id="hl-4-185"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-185">185</a>
</span><span class="lnt" id="hl-4-186"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-186">186</a>
</span><span class="lnt" id="hl-4-187"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-187">187</a>
</span><span class="lnt" id="hl-4-188"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-188">188</a>
</span><span class="lnt" id="hl-4-189"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-189">189</a>
</span><span class="lnt" id="hl-4-190"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-190">190</a>
</span><span class="lnt" id="hl-4-191"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-191">191</a>
</span><span class="lnt" id="hl-4-192"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-192">192</a>
</span><span class="lnt" id="hl-4-193"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-193">193</a>
</span><span class="lnt" id="hl-4-194"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-194">194</a>
</span><span class="lnt" id="hl-4-195"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-195">195</a>
</span><span class="lnt" id="hl-4-196"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-196">196</a>
</span><span class="lnt" id="hl-4-197"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-197">197</a>
</span><span class="lnt" id="hl-4-198"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-198">198</a>
</span><span class="lnt" id="hl-4-199"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-199">199</a>
</span><span class="lnt" id="hl-4-200"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-200">200</a>
</span><span class="lnt" id="hl-4-201"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-201">201</a>
</span><span class="lnt" id="hl-4-202"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-202">202</a>
</span><span class="lnt" id="hl-4-203"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-203">203</a>
</span><span class="lnt" id="hl-4-204"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-204">204</a>
</span><span class="lnt" id="hl-4-205"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-205">205</a>
</span><span class="lnt" id="hl-4-206"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-206">206</a>
</span><span class="lnt" id="hl-4-207"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-207">207</a>
</span><span class="lnt" id="hl-4-208"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-208">208</a>
</span><span class="lnt" id="hl-4-209"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-209">209</a>
</span><span class="lnt" id="hl-4-210"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-210">210</a>
</span><span class="lnt" id="hl-4-211"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-211">211</a>
</span><span class="lnt" id="hl-4-212"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-212">212</a>
</span><span class="lnt" id="hl-4-213"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-213">213</a>
</span><span class="lnt" id="hl-4-214"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-214">214</a>
</span><span class="lnt" id="hl-4-215"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-215">215</a>
</span><span class="lnt" id="hl-4-216"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-216">216</a>
</span><span class="lnt" id="hl-4-217"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-217">217</a>
</span><span class="lnt" id="hl-4-218"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-218">218</a>
</span><span class="lnt" id="hl-4-219"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-219">219</a>
</span><span class="lnt" id="hl-4-220"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-220">220</a>
</span><span class="lnt" id="hl-4-221"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-221">221</a>
</span><span class="lnt" id="hl-4-222"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-222">222</a>
</span><span class="lnt" id="hl-4-223"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-223">223</a>
</span><span class="lnt" id="hl-4-224"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-224">224</a>
</span><span class="lnt" id="hl-4-225"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-225">225</a>
</span><span class="lnt" id="hl-4-226"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-226">226</a>
</span><span class="lnt" id="hl-4-227"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-227">227</a>
</span><span class="lnt" id="hl-4-228"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-228">228</a>
</span><span class="lnt" id="hl-4-229"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-229">229</a>
</span><span class="lnt" id="hl-4-230"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-230">230</a>
</span><span class="lnt" id="hl-4-231"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-231">231</a>
</span><span class="lnt" id="hl-4-232"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-232">232</a>
</span><span class="lnt" id="hl-4-233"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-4-233">233</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define NUMPIXELS	72
</span></span></span><span class="line"><span class="cl"><span class="cp">#define COLOR_COMBINATIONS      6
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LINES_IN_STRIP  9
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LEDS_PER_LINE   8
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">union</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span><span class="p">{</span> <span class="c1">//LSB to MSB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">uint8_t</span> <span class="nl">red</span><span class="p">:</span><span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint8_t</span> <span class="nl">green</span><span class="p">:</span><span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint8_t</span> <span class="nl">blue</span><span class="p">:</span><span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">leds</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">color</span> <span class="n">LED_ARRAY</span><span class="p">[</span><span class="n">NUMPIXELS</span><span class="p">];</span> <span class="c1">// led complete array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="n">LEDS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ledline</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">color</span> <span class="o">*</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="n">LEDS_PER_LINE</span><span class="p">];</span> <span class="c1">// leds in line
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="n">LEDLINE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ledstrip</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LEDLINE</span> <span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="n">LINES_IN_STRIP</span><span class="p">];</span> <span class="c1">// led lines in strip
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="n">LEDSTRIP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LEDS</span> <span class="n">all_leds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">LEDSTRIP</span> <span class="n">myledstrip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">color</span> <span class="n">rainbow_array</span><span class="p">[</span><span class="n">COLOR_COMBINATIONS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ledstrip_remap</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// it is important to rework this function if the total
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// number of leds in your strip is not 72 (arranged in 9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// lines x 8 elements each)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 1st ring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">35</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">36</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">53</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">54</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">71</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 2nd ring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">34</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">37</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">52</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">55</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">70</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 3rd ring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">33</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">38</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">51</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">56</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">69</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 4th ring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">39</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">57</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">68</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 5th ring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">49</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">58</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">67</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 6th ring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">23</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">41</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">59</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">66</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 7th ring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">29</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">42</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">47</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">65</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 8th ring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">43</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">46</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">61</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 9th ring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">26</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">27</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">44</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">45</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">62</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="mi">63</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">set_rainbow_element</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">element_num</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">red</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">green</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">blue</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rainbow_array</span><span class="p">[</span><span class="n">element_num</span><span class="p">].</span><span class="n">b</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="n">red</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rainbow_array</span><span class="p">[</span><span class="n">element_num</span><span class="p">].</span><span class="n">b</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">blue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rainbow_array</span><span class="p">[</span><span class="n">element_num</span><span class="p">].</span><span class="n">b</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="n">green</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_rainbow_array</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// it is important to rework this function if the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="c1">// desired color combination array doesn&#39;t have 6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="c1">// elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">set_rainbow_element</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>   <span class="c1">// blue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">set_rainbow_element</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span> <span class="c1">// purple
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">set_rainbow_element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>   <span class="c1">// red
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">set_rainbow_element</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// orange
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">set_rainbow_element</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>   <span class="c1">// green
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">set_rainbow_element</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span> <span class="c1">// teal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">rotate_rainbow_array</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">color</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">rainbow_array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">COLOR_COMBINATIONS</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rainbow_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rainbow_array</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">rainbow_array</span><span class="p">[</span><span class="n">COLOR_COMBINATIONS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">set_strip_line_color</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">color</span> <span class="n">assigned_color</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LEDS_PER_LINE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="n">line_num</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">assigned_color</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">red</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="n">line_num</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">assigned_color</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">green</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">myledstrip</span><span class="p">.</span><span class="n">LED_LINES_IN_STRIP</span><span class="p">[</span><span class="n">line_num</span><span class="p">].</span><span class="n">LED_LINE_ELEMENTS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">assigned_color</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">blue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then the missing chunk of code in function <code>fadeFunction</code> is simpler:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-5-1"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-1"> 1</a>
</span><span class="lnt" id="hl-5-2"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-2"> 2</a>
</span><span class="lnt" id="hl-5-3"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-3"> 3</a>
</span><span class="lnt" id="hl-5-4"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-4"> 4</a>
</span><span class="lnt" id="hl-5-5"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-5"> 5</a>
</span><span class="lnt" id="hl-5-6"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-6"> 6</a>
</span><span class="lnt" id="hl-5-7"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-7"> 7</a>
</span><span class="lnt" id="hl-5-8"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-8"> 8</a>
</span><span class="lnt" id="hl-5-9"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-9"> 9</a>
</span><span class="lnt" id="hl-5-10"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-10">10</a>
</span><span class="lnt" id="hl-5-11"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-11">11</a>
</span><span class="lnt" id="hl-5-12"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-12">12</a>
</span><span class="lnt" id="hl-5-13"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-13">13</a>
</span><span class="lnt" id="hl-5-14"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-14">14</a>
</span><span class="lnt" id="hl-5-15"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-15">15</a>
</span><span class="lnt" id="hl-5-16"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-16">16</a>
</span><span class="lnt" id="hl-5-17"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-17">17</a>
</span><span class="lnt" id="hl-5-18"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-18">18</a>
</span><span class="lnt" id="hl-5-19"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-19">19</a>
</span><span class="lnt" id="hl-5-20"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-20">20</a>
</span><span class="lnt" id="hl-5-21"><a style="outline: none; text-decoration:none; color:inherit" href="#hl-5-21">21</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">rainbow</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rotate_rainbow_array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LINES_IN_STRIP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">COLOR_COMBINATIONS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">set_strip_line_color</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rainbow_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">set_strip_line_color</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rainbow_array</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">COLOR_COMBINATIONS</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMPIXELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// setPixelColor takes RGB values, from 0,0,0 up to 255,255,255, 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// this function is part of the Adafruit_NeoPixel library
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">setPixelColor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledstrip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">color_rgb</span><span class="p">(</span><span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b</span><span class="p">.</span><span class="n">red</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b</span><span class="p">.</span><span class="n">green</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">all_leds</span><span class="p">.</span><span class="n">LED_ARRAY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b</span><span class="p">.</span><span class="n">blue</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">system_soft_wdt_feed</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">show</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledstrip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://lopeztel.noho.st/piwigo/galleries/blog_media/rainbow.gif#center" alt=""  />
</p>
<p>This is my first attempt at explaining code in a blog post, hopefully the idea got across, at least writing this helps me organize my thoughts</p>
<hr>
<p>Day 15 of my 2021’s <a href="https://lopeztel.xyz/blog/tags/100daystooffload/">#100DaysToOffload</a></p>
<p>Join <a href="https://100daystooffload.com/">100DaysToOffload</a>!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://lopeztel.xyz/blog/tags/100daystooffload/">100DaysToOffload</a></li>
      <li><a href="https://lopeztel.xyz/blog/tags/esp8266/">esp8266</a></li>
      <li><a href="https://lopeztel.xyz/blog/tags/rgblamp/">RGBLamp</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://lopeztel.xyz/blog/2021/07/05/making-a-bluetooth-split-keyboard-part-1-a/">
    <span class="title">« Prev</span>
    <br>
    <span>Making a bluetooth split keyboard (Part 1-a)</span>
  </a>
  <a class="next" href="https://lopeztel.xyz/blog/2021/06/26/infinitime-1-2-0-on-pinetime-from-scratch/">
    <span class="title">Next »</span>
    <br>
    <span>Infinitime 1.2-0 on PineTime, from scratch</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://lopeztel.xyz/blog">Lopeztel&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
